import os
import requests
import subprocess
import threading
from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

# URLs de download do server.jar para diferentes versões
# NOTA: Estas são URLs de exemplo. Você pode precisar encontrar URLs de download atualizadas.
MINECRAFT_SERVER_URLS = {
    "1.21": "https://piston-data.mojang.com/v1/objects/459c3a37217e91122a6a0b943d226a0b1f23788a/server.jar",
    "1.20.4": "https://piston-data.mojang.com/v1/objects/16e91789c3a647e30da6a4405370d02b8d002f23/server.jar",
    "1.19.4": "https://piston-data.mojang.com/v1/objects/c9df178a9c2a3e0f9b378036254a8a92892306d8/server.jar",
    "1.18.2": "https://piston-data.mojang.com/v1/objects/c8f42d20b601618a38c2274b7617b07038167f0c/server.jar",
}

@app.route('/api/create-server', methods=['POST'])
def create_server():
    """
    Endpoint para criar um servidor Minecraft.
    Ele recebe o nome do servidor e a versão,
    cria uma pasta, baixa o server.jar e inicia o servidor.
    """
    data = request.json
    server_name = data.get('serverName')
    minecraft_version = data.get('minecraftVersion')

    if not server_name or not minecraft_version:
        return jsonify({"message": "Nome do servidor e versão do Minecraft são obrigatórios."}), 400

    # Certifique-se de que a versão é válida
    if minecraft_version not in MINECRAFT_SERVER_URLS:
        return jsonify({"message": "Versão do Minecraft inválida."}), 400

    # Cria a pasta do servidor
    server_path = os.path.join(os.getcwd(), 'servers', server_name)
    os.makedirs(server_path, exist_ok=True)

    try:
        # Baixa o server.jar
        server_jar_url = MINECRAFT_SERVER_URLS[minecraft_version]
        server_jar_path = os.path.join(server_path, 'server.jar')
        
        print(f"Baixando server.jar para a versão {minecraft_version}...")
        response = requests.get(server_jar_url, stream=True)
        response.raise_for_status() # Lança um erro para requisições com status ruim
        with open(server_jar_path, 'wb') as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
        print("Download do server.jar concluído.")

        # Cria o eula.txt para aceitar os termos do Minecraft
        eula_path = os.path.join(server_path, 'eula.txt')
        with open(eula_path, 'w') as f:
            f.write("eula=true")

        # Inicia o servidor em uma nova thread para não bloquear a requisição HTTP
        def start_minecraft_server():
            print(f"Iniciando o servidor {server_name}...")
            # Altere o diretório para a pasta do servidor antes de executar
            os.chdir(server_path)
            # -Xmx1024M define a quantidade de RAM que o servidor usará (1GB neste exemplo)
            # Você pode ajustar isso se necessário
            subprocess.run(['java', '-Xmx1024M', '-Xms1024M', '-jar', 'server.jar', 'nogui'])
            print(f"Servidor {server_name} parado.")

        server_thread = threading.Thread(target=start_minecraft_server)
        server_thread.daemon = True # Permite que a thread seja encerrada com o programa principal
        server_thread.start()

        # Retorna o endereço do servidor para o frontend
        # Este é um IP de exemplo, você deve usar o IP real do seu túnel do Playit.gg
        server_address = "questions-couple.gl.at.ply.gg:4630"
        return jsonify({"message": f"Servidor {server_name} criado e iniciando!", "server_address": server_address}), 200

    except requests.exceptions.RequestException as e:
        return jsonify({"message": f"Erro ao baixar o server.jar: {e}"}), 500
    except Exception as e:
        return jsonify({"message": f"Ocorreu um erro inesperado: {e}"}), 500

if __name__ == '__main__':
    # O comando `os.getcwd()` retorna o diretório de trabalho atual.
    # O diretório 'servers' será criado neste local.
    os.makedirs(os.path.join(os.getcwd(), 'servers'), exist_ok=True)
    app.run(host='0.0.0.0', port=5000, debug=True)
